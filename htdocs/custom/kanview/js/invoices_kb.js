document.write('<div id="messages"></div>'),document.write('<div id="waitingPopUp"></div>'),document.write('<div id="kanban_invoices"></div>');var c=null,a=null,r=null,e={};e[invoice_late_status_0]="INVOICE_LATE_STATUS_0",e[invoice_late_status_1]="INVOICE_LATE_STATUS_1",e[invoice_late_status_2]="INVOICE_LATE_STATUS_2",e[invoice_late_status_3]="INVOICE_LATE_STATUS_3";var s=null,_=null,u="7100f2bf7f",t="85bd6008d9",f=parent1,A=parent2,O=document.URL,g=mytitle,m="053065326f",n="4ca0de651a",b="NER",o="#mainmenua_"+A+" > span:nth-child(1)",w=$(o).text();function E(e,t,n,o,i,a){null==o&&(o=""),null==i&&(i=""),null==a&&(a="");var r=document.URL;r=-1===r.indexOf("?")?r+="?":r+="&",r+="id="+t+"&newStatusID="+n+"&action=cardDrop",r+="&idwarehouse="+o,r+="&close_code="+i,r+="&close_note="+a,r+="&token="+token,r=encodeURI(r),$("#waitingPopUp").ejWaitingPopup().data("ejWaitingPopup").show();var d="";return transform(g).indexOf(m)<0?"KO":($.ajax({url:r,type:"GET",dataType:"html",async:!1,success:function(e,t){if(O.indexOf(A)<0)throw b;try{var n=JSON.parse(e);token=n.token,"OK"===n.status?(""!=n.message&&$.jnotify(n.message),d=void 0!==n.data.newRef?"OK||"+n.data.newRef:"OK",$(".badge").each(function(e){void 0!==n.data.kanbanHeaderCounts[this.id]&&(this.textContent=n.data.kanbanHeaderCounts[this.id])})):($.jnotify(n.message,"warning",5e3),$("#kanban_invoices").find(".e-targetclone").remove(),$("body").css("cursor","default"),d="KO")}catch(e){$.jnotify(e,"error",5e3),d="KO"}},error:function(e,t,n){alert(n),d="KO"},complete:function(e,t){$("#waitingPopUp").ejWaitingPopup().data("ejWaitingPopup").hide()}}),transform(w).indexOf(m)<0&&(d="KO"),d)}$(function(){s=ej.DataManager(kanbanData),_=$("#kanban_invoices").ejKanban({enableTotalCount:enableNativeTotalCount,dataSource:s,locale:sfLocale,enableRTL:!1,columns:columns,keyField:"kanban_status",fields:{content:"facnumber_tiers",primaryKey:"rowid",priority:"priority",tag:invoices_tag,title:"",color:"late_status",imageUrl:"undefined"!=typeof fieldImageUrl&&""!=fieldImageUrl?fieldImageUrl:null,collapsibleCards:{field:"",key:""}},cardSettings:{colorMapping:e,template:"",externalDropTarget:""},contextMenuSettings:{enable:!0,menuItems:[],customMenuItems:[{text:msgPrintKanbanView,target:ej.Kanban.Target.Header,template:""}]},cardDragStop:function(e){if(O.indexOf(f)<0&&this.destroy(),transform(f).indexOf(u)<0)throw b;var t=$(e.draggedElement).parent().data("ej-mappingkey"),n=$(e.dropTarget).parent().data("ej-mappingkey"),o=columnIDs[n];if(void 0===n||void 0===t||n===t||"INVOICE_VALIDATED"!==n&&"INVOICE_DRAFT"===t||"INVOICE_PAID"===n&&"INVOICE_TO_CLASSIFY_PAID"!==t&&"INVOICE_PARTIALLY_PAID"!==t||"INVOICE_VALIDATED"===n&&e.data[0][0].nbre_lignes<=0||"INVOICE_ABANDONED"===n&&"INVOICE_PARTIALLY_PAID"===t||"INVOICE_LATE"===n||"INVOICE_PARTIALLY_PAID"===n&&("INVOICE_PAID"!==t||e.data[0][0].total_paye===e.data[0][0].total_ttc)||"INVOICE_TO_CLASSIFY_PAID"===n)return e.cancel=!0,$("#kanban_invoices").find(".e-targetclone").remove(),$("body").css("cursor","default"),void("INVOICE_VALIDATED"===n&&e.data[0][0].nbre_lignes<=0?$.jnotify(ActionNotAllowed_EmptyInvoice,"warning"):"INVOICE_VALIDATED"!==n&&"INVOICE_DRAFT"===t?$.jnotify(ActionNotAllowed_YouMustValidateFirst,"warning"):$.jnotify(ActionNotAllowed,"warning"));if(O.indexOf(A)<0)throw b;if("INVOICE_VALIDATED"==n&&"INVOICE_DRAFT"==t){if(stock_enabled&&e.data[0][0].qualified_for_stock_change)return warehouseListEmpty?$.jnotify(ValidationNotAllowed_NoWarehouse,"error"):(draggedItemRowid=e.data[0][0].rowid,$("#warehouse_choice_dialog").ejDialog("open")),e.cancel=!0,$("#kanban_invoices").find(".e-targetclone").remove(),void $("body").css("cursor","default")}else{if("INVOICE_PAID"==n&&"INVOICE_PARTIALLY_PAID"==t)return draggedItemRowid=e.data[0][0].rowid,$("#set_paid_dialog").ejDialog("open"),e.cancel=!0,$("#kanban_invoices").find(".e-targetclone").remove(),void $("body").css("cursor","default");if("INVOICE_ABANDONED"==n&&("INVOICE_VALIDATED"==t||"INVOICE_LATE"==t))return draggedItemRowid=e.data[0][0].rowid,$("#set_abandoned_dialog").ejDialog("open"),e.cancel=!0,$("#kanban_invoices").find(".e-targetclone").remove(),void $("body").css("cursor","default")}if(transform(w).indexOf(m)<0)throw b;var i=$(e.draggedElement).prop("id"),a=E(e,i,o,"");if("KO"!=a){if(O.indexOf(f)<0)throw b;var r=kanbanData.find(function(e){return e.rowid===i});if("INVOICE_VALIDATED"==n&&"INVOICE_DRAFT"==t){var d=a.split("||"),l="";if(1<d.length&&(l=d[1].trim()),r.late?(e.cancel=!0,r.kanban_status="INVOICE_LATE"):r.kanban_status="INVOICE_VALIDATED",w!==g)throw b;if(""!==l){r.facnumber=l;var c='<div id="invoice-'+r.rowid+'">',I=DOL_VERSION<"6.0.0"?"/compta/facture.php?facid=":"/compta/facture/card.php?id=";r.facnumber_tiers='<a class="object-link" href="'+DOL_URL_ROOT+I+r.rowid+'" target="_blank">'+r.facnumber+"</a>"+c+r.societe_nom+"</div>"}_.refresh(!0)}else if("INVOICE_VALIDATED"==n&&"INVOICE_DRAFT"!=t){if(e.cancel=!0,r.late?r.kanban_status="INVOICE_LATE":r.total_paye>=r.total_ttc?r.kanban_status="INVOICE_TO_CLASSIFY_PAID":0<r.total_paye&&r.total_paye<r.total_ttc?r.kanban_status="INVOICE_PARTIALLY_PAID":r.kanban_status="INVOICE_VALIDATED",transform(f).indexOf(u)<0)throw b;_.refresh(!0)}window.setTimeout(function(){$("#"+i).css("border-color","magenta")},100),O.indexOf(f)<0&&(s=null)}else e.cancel=!0,$("#kanban_invoices").find(".e-targetclone").remove(),$("body").css("cursor","default")},cardDrop:function(e){},cardClick:function(e){if(transform(g).indexOf(m)<0)throw b;if(!tooltipsActive){console.log(tooltipsActive);var t=s.dataSource.json.length,n=-1,o="";for(i=0;i<t;i++)n=s.dataSource.json[i].rowid,o=s.dataSource.json[i].tooltip_content,$("#invoice-"+n).ejTooltip({content:o}),$(".tooltip-ref-"+n).each(function(e){$(this).text(s.dataSource.json[i].facnumber)});tooltipsActive=!0}},contextClick:function(e){if(O.indexOf(A)<0)throw b;"ejMenuClick"!=e.type&&"contextClick"!=e.type||e.text!=msgPrintKanbanView||this.print()},queryCellInfo:function(e){var t=DOL_VERSION<"6.0.0"?"soc.php":"card.php";if(transform(w).indexOf(m)<0)throw b;null!=e.data.fk_soc&&""!=e.data.fk_soc&&null!=e.data.societe_nom&&""!=e.data.societe_nom&&$(e.card).find("div.e-card_image").wrap('<a href="'+DOL_URL_ROOT+"/societe/"+t+"?socid="+e.data.fk_soc+'" title="'+e.data.societe_nom+'" target="_blank"></a>')}}).data("ejKanban"),transform(w).indexOf(m)<0&&window.setTimeout(function(){_.destroy()},100),c=$("#warehouse_choice_dialog").ejDialog({title:msgWarehouseChoice,enableModal:!0,enableResize:!1,locale:sfLocale,enableRTL:!1,showOnInit:!1}).data("ejDialog");var l=$("#warehouse_choice_list").ejListBox({itemsCount:5}).data("ejListBox");$("#btnOK_Warehouse").ejButton({type:"button",size:"mini",showRoundedCorner:!0,click:function(e){if(O.indexOf(f)<0)throw b;var t=0;if(0<l.getSelectedItems().length&&(t=l.getSelectedItems()[0].value),0<t){var n=E(null,draggedItemRowid,"INVOICE_VALIDATED",t);if("KO"!==n){var o=kanbanData.find(function(e){return e.rowid===draggedItemRowid}),i=n.split("||"),a="";if(1<i.length&&(a=i[1].trim()),o.late?o.kanban_status="INVOICE_LATE":o.kanban_status="INVOICE_VALIDATED",""!==a){o.facnumber=a;var r='<div id="invoice-'+o.rowid+'">',d=DOL_VERSION<"6.0.0"?"/compta/facture.php?facid=":"/compta/facture/card.php?id=";o.facnumber_tiers='<a class="object-link" href="'+DOL_URL_ROOT+d+o.rowid+'" target="_blank">'+o.facnumber+"</a>"+r+o.societe_nom+"</div>"}if(w!==g)throw b;_.refresh(!0)}}if(transform(f).indexOf(u)<0)throw b;c.close(),window.setTimeout(function(){$("#"+draggedItemRowid).css("border-color","magenta")},100)}}),$("#btnCancel_Warehouse").ejButton({type:ej.ButtonType.Button,size:"mini",showRoundedCorner:!0,click:function(e){if(transform(g).indexOf(m)<0)throw b;c.close()}}),a=$("#set_paid_dialog").ejDialog({title:msgInvoice_SetPaid_DialogTitle,enableModal:!0,enableResize:!1,locale:sfLocale,enableRTL:!1,showOnInit:!1}).data("ejDialog");var n=$("#set_paid_reason_choice_list").ejListBox({itemsCount:3,width:370,select:function(e){$("#btnOK_SetPaid").ejButton({enabled:!0})}}).data("ejListBox");$("#txtReason_SetPaid");$("#btnOK_SetPaid").ejButton({type:"button",size:"mini",showRoundedCorner:!0,enabled:!1,click:function(e){var t=0;if(0<n.getSelectedItems().length&&(t=n.getSelectedItems()[0].value),void 0!==t&&""!=t){if("KO"!==E(null,draggedItemRowid,"INVOICE_PAID","",t,$("#txtReason_SetPaid").val())){if(kanbanData.find(function(e){return e.rowid===draggedItemRowid}).kanban_status="INVOICE_PAID",O.indexOf(A)<0)throw b;_.refresh(!0)}window.setTimeout(function(){$("#"+draggedItemRowid).css("border-color","magenta")},100)}if(transform(w).indexOf(m)<0)throw b;a.close()}}),$("#btnCancel_SetPaid").ejButton({type:ej.ButtonType.Button,size:"mini",showRoundedCorner:!0,click:function(e){if(O.indexOf(f)<0)throw b;a.close()}}),r=$("#set_abandoned_dialog").ejDialog({title:msgInvoice_SetAbandoned_DialogTitle,enableModal:!0,enableResize:!1,locale:sfLocale,enableRTL:!1,showOnInit:!1}).data("ejDialog");var o=$("#set_abandoned_reason_choice_list").ejListBox({itemsCount:3,width:370,select:function(e){$("#btnOK_SetAbandoned").ejButton({enabled:!0})}}).data("ejListBox");$("#txtReason_SetAbandoned"),$("#btnOK_SetAbandoned").ejButton({type:"button",size:"mini",enabled:!1,showRoundedCorner:!0,click:function(e){var t=0;if((0<o.getSelectedItems().length&&(t=o.getSelectedItems()[0].value),void 0!==t&&""!=t)&&"KO"!==E(null,draggedItemRowid,"INVOICE_ABANDONED","",t,$("#txtReason_SetAbandoned").val())){if(kanbanData.find(function(e){return e.rowid===draggedItemRowid}).kanban_status="INVOICE_ABANDONED",O.indexOf(f)<0)throw b;_.refresh(!0)}if(w!==g)throw b;r.close(),window.setTimeout(function(){$("#"+draggedItemRowid).css("border-color","magenta")},100)}}).data("ejButton");$("#btnCancel_SetAbandoned").ejButton({type:ej.ButtonType.Button,size:"mini",showRoundedCorner:!0,click:function(e){r.close()}})}),window.onerror=function(e,t,n,o,i){return $("#waitingPopUp").ejWaitingPopup().data("ejWaitingPopup").hide(),console.log(e),!1};